<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Ops Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-BLOCK { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;}
        .status-FLAG { background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-weight: bold;}
        .status-ALLOW { background-color: #198754; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;}
        .reason-text { font-size: 0.85rem; color: #666; font-style: italic; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üõ°Ô∏è Bhaviour Security Admin</h2>
            <div id="connection-status" class="text-muted">Connecting...</div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4"><div class="card p-3 bg-danger text-white"><h3>Blocked</h3><h1 id="blocked-count">0</h1></div></div>
            <div class="col-md-4"><div class="card p-3 bg-warning"><h3>Flagged</h3><h1 id="flagged-count">0</h1></div></div>
            <div class="col-md-4"><div class="card p-3 bg-success text-white"><h3>Approved</h3><h1 id="allowed-count">0</h1></div></div>
        </div>

        <div class="card p-4">
            <h4>Live Feed</h4>
            <table class="table table-hover mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Amount</th>
                        <th>Country</th>
                        <th>Fraud Risk</th>
                        <th>Anomaly Score</th>
                        <th>Reason</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchData() {
            try {
                const response = await fetch('/api/history?t=' + Date.now());
                const data = await response.json();
                
                document.getElementById('connection-status').innerText = "üü¢ Live - Last updated: " + new Date().toLocaleTimeString();

                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                let stats = { BLOCK: 0, FLAG: 0, ALLOW: 0 };

                if (data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='8' class='text-center'>No transactions yet...</td></tr>";
                    return;
                }

                data.forEach(txn => {
                    if (stats[txn.action] !== undefined) stats[txn.action]++;
                    
                    // Note: 'reasons' is the column name in your SQLite DB 
                    // 'risk_score' is the ML probability
                    // We calculate anomaly_score display (scaled for visibility if needed)
                    
                    const row = `<tr>
                        <td>${new Date(txn.timestamp).toLocaleTimeString()}</td>
                        <td>${txn.user_id}</td>
                        <td>$${txn.amount}</td>
                        <td>${txn.country}</td>
                        <td><b>${(txn.risk_score * 100).toFixed(1)}%</b></td>
                        <td>${txn.anomaly_score ? txn.anomaly_score.toFixed(3) : 'N/A'}</td>
                        <td class="reason-text">${txn.reasons || 'N/A'}</td>
                        <td><span class="status-${txn.action}">${txn.action}</span></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                document.getElementById('blocked-count').innerText = stats.BLOCK;
                document.getElementById('flagged-count').innerText = stats.FLAG;
                document.getElementById('allowed-count').innerText = stats.ALLOW;
            } catch (e) { 
                console.error(e); 
                document.getElementById('connection-status').innerText = "üî¥ Connection Lost";
            }
        }
        setInterval(fetchData, 2000); 
        fetchData();
    </script>
</body>
</html>